# 5. バックテスト自動比較機能 要件定義 (v1.0)

## 5.1. 目的

AAVC戦略の有効性を客観的に評価するため、標準的な投資戦略（ドルコスト平均法、一括投資）とパフォーマンスを直接比較する機能を提供する。
比較結果は、サマリー表とチャートによって直感的に理解できる形式で出力する。

## 5.2. 主要機能

- `backtest` コマンド実行時に、AAVC戦略に加えて以下の2つの戦略のシミュレーションを自動で実行する。
  - ドルコスト平均法 (DCA)
  - 一括投資 (Buy & Hold)
- 3つの戦略の主要なパフォーマンス指標を、コンソールのサマリー表に並べて表示する。
- オプションで、3つの戦略の資産推移を一つのグラフに描画したチャート画像をファイルとして保存する。

## 5.3. 比較戦略の定義

- **AAVC**: 既存のロジック。
- **ドルコスト平均法 (DCA)**:
  - **ロジック**: `backtest` コマンドで指定された `base_amount`（基準投資額）を、シミュレーション期間中の全営業日にわたって機械的に投資し続ける。
- **一括投資 (Buy & Hold)**:
  - **ロジック**: AAVC戦略がシミュレーション期間中に投じた `total_invested`（総投資額）と同額の資金を、シミュレーション**初日**に全額投資し、最終日まで保有し続ける。これにより、AAVCと「総投資額」の条件を揃え、公平な比較を行う。

## 5.4. 出力形式

### 5.4.1. サマリー比較表 (コンソール出力)

`backtest` コマンドのデフォルトの出力として、以下の形式でマークダウンテーブルを表示する。各指標の定義は詳細設計書で別途定義する。

```
## Backtest Result: AAPL (2023-01-01 to 2025-01-01)

| Metric(指標)     | AAVC         | DCA      | Buy & Hold |
|:-----------------|:-------------|:---------|:-----------|
| Final Value      | **¥152k**    | ¥145k    | ¥138k      |
| Ann. Return      | **+23.3%**   | +15.2%   | +17.5%     |
| Total Return     | **+52.0%**   | +32.7%   | +38.0%     |
| Max Drawdown     | **-15.5%**   | -20.1%   | -25.0%     |
| Volatility(Ann.) | **18.2%**    | 19.5%    | 22.0%      |
| Sharpe Ratio     | **1.50**     | 1.20     | 1.15       |
| Total Invested   | **¥100k**    | ¥110k    | ¥100k      |

```
*(注: 上記の数値はサンプルです。)*

### 5.4.2. 比較チャート (ファイル出力)

- **実行トリガー**: `--plot` フラグが `backtest` コマンドに付与された場合のみ実行。
- **ファイル名**: `backtest_chart_[ticker]_[start_date]_to_[end_date].png` (例: `backtest_chart_AAPL_2023-01-01_to_2025-01-01.png`)
- **グラフ仕様**:
  - **X軸**: 時間 (日付)
  - **Y軸**: 資産評価額 (円)
  - **プロット**: 以下の3本の折れ線グラフを、色分けして描画する。
    1. AAVC戦略の資産推移
    2. DCA戦略の資産推移
    3. Buy & Hold戦略の資産推移
  - **凡例**: 各線がどの戦略に対応するかを明確に示す。
  - **タイトル**: 銘柄と期間がわかるタイトルを付ける。

## 5.5. CLIの変更点

### 5.5.1. 必須引数
- `--ticker` / `-t`: バックテスト対象のティッカーシンボル
- `--start-date`: バックテスト開始日 (YYYY-MM-DD形式)
- `--end-date`: バックテスト終了日 (YYYY-MM-DD形式)
- `--amount` / `-a`: 基準投資額

### 5.5.2. オプション引数
- `--ref-price`: 基準価格（指定しない場合、期間内の最古の価格を使用）
- `--asymmetric-coefficient`: AAVC戦略の非対称係数（デフォルト: 1.0）
- `--volatility-period`: ボラティリティ計算期間（デフォルト: 20）
- `--plot`: チャート画像の生成と保存（オプション）

### 5.5.3. 使用例
```bash
# 基本的なバックテスト
python -m src.AAVC_calculate_tool backtest \
  --ticker AAPL \
  --start-date 2023-01-01 \
  --end-date 2024-01-01 \
  --amount 10000

# チャート付きバックテスト
python -m src.AAVC_calculate_tool backtest \
  --ticker AAPL \
  --start-date 2023-01-01 \
  --end-date 2024-01-01 \
  --amount 10000 \
  --plot
```

## 5.6. 依存ライブラリ

- チャート描画のために、`matplotlib` ライブラリが新たに必要となる。`pyproject.toml` および `requirements.txt` に追加する。

## 5.7. パフォーマンス指標の定義

### 5.7.1. 収益性指標
- **Final Value**: 最終的なポートフォリオ価値
- **Total Return**: 総投資額に対する総収益率（%）
- **Annual Return**: 年率収益率（%）

### 5.7.2. リスク指標
- **Max Drawdown**: 最大下落率（%）
- **Volatility (Annual)**: 年率ボラティリティ（%）
- **Sharpe Ratio**: シャープレシオ（リスク調整後収益率）

### 5.7.3. 投資額指標
- **Total Invested**: 期間中の総投資額

## 5.8. エラーハンドリング

- **TickerNotFoundError**: 指定されたティッカーが見つからない場合
- **DataFetchError**: データ取得に失敗した場合
- **引数検証エラー**: 必須引数が不足している場合
- **日付形式エラー**: 日付が正しい形式でない場合
